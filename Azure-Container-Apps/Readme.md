# ARM Template Generator - Single Source of Truth

This solution eliminates the tedious process of updating multiple files when adding environment variables or changing Azure resources.

## âœ¨ Benefits

**Before (Manual Approach):**
- âŒ Add new env variable: Update 4 places in template + 1 in parameters
- âŒ Change RG/Subscription: Update 4+ places in template + multiple in parameters
- âŒ Error-prone and time-consuming

**After (Automated Approach):**
- âœ… Add new env variable: Update **1 line** in `variable.json`
- âœ… Change RG/Subscription: Update **1 section** in `variable.json`
- âœ… Run script â†’ Done!

## ğŸ“ Project Structure
```
.
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ generate_templates.sh
â”œâ”€â”€ backend-sales
â”‚   â”œâ”€â”€ backend_variable.json
â”‚   â”œâ”€â”€ template.json          (generated)
â”‚   â””â”€â”€ parameters.json        (generated)
â””â”€â”€ sales_ui
    â”œâ”€â”€ sales_ui_variable.json
    â”œâ”€â”€ template.json          (generated)
    â””â”€â”€ parameters.json        (generated)
```

## ğŸš€ Usage

### Deploy Single App

```bash
./deploy.sh backend-sales sales-sol-web-2
```

### Deploy Another App

```bash
./deploy.sh backend-salessales-sol-web-2
```

### Deploy All Apps

```bash
./deploy.sh all sales-sol-web-2
```

## âœ… What It Does

1. **Validates Resource Group** - Checks that the RG you provide matches the one in the variable.json
2. **Generates Templates** - Creates `template.json` and `parameters.json` in the same folder
3. **Deploys to Azure** - Runs `az deployment group create`

## ğŸ”’ Resource Group Validation

The script will **fail** if the resource group doesn't match:

```bash
./deploy.sh backend-saleswrong-resource-group

# Output:
# âŒ Error: Resource group mismatch!
#    Expected (from config): sales-sol-web-2
#    Provided: wrong-resource-group
```

## ğŸ“‹ Command Format

```bash
./deploy.sh <app-folder|all> <resource-group>
```

**Parameters:**
- `<app-folder>` - Folder name (backend-sales, sales_ui) or "all"
- `<resource-group>` - Azure resource group name

## ğŸ“ Examples

### Example 1: Deploy Backend Sales
```bash
./deploy.sh backend-sales sales-sol-web-2

# This will:
# 1. Read backend-sales/backend_variable.json
# 2. Validate resource group
# 3. Generate backend-sales/template.json
# 4. Generate backend-sales/parameters.json
# 5. Deploy to Azure
```

### Example 2: Deploy Sales UI
```bash
./deploy.sh sales_ui sales-sol-web-2
```

### Example 3: Deploy All Apps
```bash
./deploy.sh all sales-sol-web-2

# This will deploy:
# - backend-sales
# - sales_ui
# - Any other folder with *_variable.json file
```

## ğŸ¯ Generated Files Location

Templates are generated **in the same folder** as the variable file:

```
backend-sales/
â”œâ”€â”€ backend_variable.json   (your config)
â”œâ”€â”€ template.json             (generated by script)
â””â”€â”€ parameters.json           (generated by script)
```

You can review these files anytime:
```bash
cat backend-sales/template.json
cat backend-sales/parameters.json
```

## âš™ï¸ Prerequisites

```bash
# Install jq
sudo apt-get install jq  # Ubuntu/Debian
brew install jq          # macOS

# Login to Azure
az login

# Make scripts executable
chmod +x deploy.sh
chmod +x generate_templates.sh
```

## ğŸ”„ Workflow

```bash
# 1. Update your config
vim backend-sales/backend_variable.json

# 2. Deploy (it will generate templates automatically)
./deploy.sh backend-sales sales-sol-web-2

# 3. Review generated files (optional)
cat backend-sales/template.json
git diff backend-sales/
```

## âŒ Error Handling

The script will fail if:
- âœ… Folder doesn't exist
- âœ… Variable file not found
- âœ… Resource group mismatch
- âœ… Template generation fails
- âœ… Azure deployment fails

## ğŸ“Š Output Example

```bash
$ ./deploy.sh backend-sales sales-sol-web-2

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Azure Container Apps Deployment
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ“¦ Deploying: backend-sales
ğŸ“„ Config: backend-sales/backend_variable.json

âœ… Resource group validated: sales-sol-web-2

ğŸ”§ Generating templates...
âœ“ Generated backend-sales/template.json
âœ“ Generated backend-sales/parameters.json

âœ… Templates generated:
   ğŸ“„ backend-sales/template.json
   ğŸ“„ backend-sales/parameters.json

ğŸš€ Deploying to Azure...
   App: backend-sales
   RG: sales-sol-web-2

[Deployment progress...]

âœ… Successfully deployed: backend-sales
```

## ğŸ‰ That's It!

Super simple:
1. Run `./deploy.sh <folder> <resource-group>`
2. Templates are generated in the app folder
3. App is deployed to Azure


## ğŸ“ How to Use

### 1. Add New Environment Variable

Edit `variable.json`:

```json
{
  "environmentVariables": {
    "nonSecrets": {
      "EXISTING_VAR": "value",
      "NEW_API_URL": "https://api.example.com",  // <- Just add this
      "NEW_FEATURE_FLAG": "true"                 // <- And this
    }
  }
}


### 2. Add New Secret Variable

Edit `variable.json`:

```json
{
  "environmentVariables": {
    "secrets": {
      "EXISTING_SECRET": {
        "keyVaultSecret": "existing-secret"
      },
      "NEW_API_KEY": {                          // <- Add this
        "keyVaultSecret": "new-api-key"
      }
    }
  }
}
```


### 3. Change Resource Group or Subscription

Edit `variable.json`:

```json
{
  "subscription": {
    "id": "NEW-SUBSCRIPTION-ID-HERE"  // <- Change once
  },
  "resourceGroup": {
    "name": "new-resource-group"      // <- Change once
  },
  "keyVault": {
    "name": "new-key-vault"           // <- Change once
  }
}
```


Run the generator - all resource IDs are automatically updated!

### 4. Update Container Image

```json
{
  "containerApp": {
    "imageName": "acrd2crg2.azurecr.io/myapp:v2.0.0"  // <- Change once
  }
}
```

### 5. Add New Volume

```json
{
  "volumes": [
    {
      "name": "new-volume",
      "storageName": "new-storage-account-name",
      "mountPath": "/app/new-data"
    }
  ]
}
```

## ğŸ”§ Configuration Reference

### Core Azure Resources

```json
{
  "subscription": {
    "id": "your-subscription-id"
  },
  "resourceGroup": {
    "name": "your-resource-group"
  },
  "keyVault": {
    "name": "your-key-vault-name"
  }
}
```

### Container Configuration

```json
{
  "containerApp": {
    "name": "container-name",
    "location": "westeurope",
    "imageName": "registry.azurecr.io/image:tag",
    "targetPort": 8080,
    "ingress": {
      "enabled": true,        // Set to false to disable ingress completely
      "external": true,       // true = public, false = internal only
      "transport": "auto",    // "auto", "http", "http2"
      "allowInsecure": false  // Allow HTTP (true) or HTTPS only (false)
    },
    "resources": {
      "cpu": 1,
      "memory": "2Gi",
      "ephemeralStorage": "4Gi"
    },
    "scaling": {
      "minReplicas": 1,
      "maxReplicas": 5
    }
  }
}
```

### Environment Variables

**Non-Secret Variables:**
```json
{
  "environmentVariables": {
    "nonSecrets": {
      "DEBUG": "false",
      "API_URL": "https://api.example.com",
      "FEATURE_FLAG": "true"
    }
  }
}
```

**Secret Variables (from Key Vault):**
```json
{
  "environmentVariables": {
    "secrets": {
      "API_KEY": {
        "keyVaultSecret": "api-key-secret-name"
      },
      "DATABASE_PASSWORD": {
        "keyVaultSecret": "db-password"
      }
    }
  }
}
```

## ğŸ¯ Common Scenarios

### Scenario 1: Moving to Different Environment

```json
// Change these in variable.json:
{
  "subscription": { "id": "prod-subscription-id" },
  "resourceGroup": { "name": "prod-rg" },
  "keyVault": { "name": "prod-kv" },
  "containerApp": {
    "imageName": "acr.azurecr.io/app:prod-v1.0",
    "location": "eastus"
  },
  "environmentVariables": {
    "nonSecrets": {
      "DEBUG": "false",
      "ENV": "production"
    }
  }
}
```

### Scenario 2: Adding Multiple Variables at Once

```json
{
  "environmentVariables": {
    "nonSecrets": {
      // Add as many as you want
      "CACHE_ENABLED": "true",
      "LOG_LEVEL": "INFO",
      "WORKER_THREADS": "4",
      "TIMEOUT_SECONDS": "30"
    }
  }
}
```

### Scenario 3: Background Worker (No Ingress)

For containers that don't need HTTP endpoints (message queue consumers, scheduled jobs, etc.):

```json
{
  "containerApp": {
    "name": "background-worker",
    "ingress": {
      "enabled": false  // Disables all HTTP/HTTPS endpoints
    }
  },
  "environmentVariables": {
    "nonSecrets": {
      "QUEUE_CONNECTION": "...",
      "PROCESS_INTERVAL": "60"
    }
  }
}
```


```

## ğŸš€ Deployment

After generating templates:

```bash
# Login to Azure
az login

# Deploy
az deployment group create \
  --resource-group YOUR-RESOURCE-GROUP \
  --template-file template.json \
  --parameters parameters.json

# Or with specific subscription
az deployment group create \
  --subscription YOUR-SUBSCRIPTION-ID \
  --resource-group YOUR-RESOURCE-GROUP \
  --template-file template.json \
  --parameters parameters.json
```



## ğŸ“š Best Practices

1. **Version Control**: Commit `variable.json` and generator scripts, not generated files
2. **Separate Configs**: Use different `variable.json` files per environment
3. **Secret Management**: Never put actual secrets in `variable.json` - always use Key Vault references
4. **Validation**: Run `az deployment group validate` before deploying
5. **Documentation**: Document custom variables in comments (use YAML format for comments if needed)

## ğŸ¤ Contributing

Improvements welcome! Common enhancements:
- Add validation for required fields
- Support for additional Azure resources
- Environment-specific overrides
- Secret rotation helpers

## ğŸ“„ License

Use freely for your Azure deployments!
